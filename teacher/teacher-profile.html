<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>优课联盟</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="shortcut icon" href="../header-footer/images/ico.png" type="image/x-icon">
    <link rel="stylesheet" href="../Homepage/css/header.css">
    <link rel="stylesheet" href="../header-footer/common.css">
    <link rel="stylesheet" href="../student/student-profile.css">
    <link rel="stylesheet" href="../teacher/teacher-profile.css">
    <link rel="stylesheet" href="courseManager.css">
</head>

<body>
    <!-- 页眉 -->
    <header class="navbar">
        <div class="nav">
            <div class="logo">
                <a href="../Homepage/WebsiteHomepage.html"><img src="../header-footer/images/logo.png" alt="优课联盟"></a>
            </div>
            <nav>
                <ul>
                    <!-- TODO 补充链接 -->
                    <li><a href="../Homepage/WebsiteHomepage.html">首页</a></li>
                    <li><a href="../Homepage/courseList.html">课程</a></li>
                    <li><a href="../Homepage/league.html">联盟院校</a></li>
                    <li><a href="../Homepage/about.html">关于我们</a></li>
                </ul>
            </nav>
        </div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="搜索课程...">
            <button type="button" id="searchButton"><i class="fas fa-search"></i></button>
        </div>
        <div class="info">
            <!-- TODO 补充链接 -->
        </div>
    </header>
    <!-- 主体 -->
    <div class="student-profile-header">
        <div class="student-profile-head">
            <img id="avatar" src="" alt="用户头像">
            <div class="student-profile-info">
                <h2 id="user-name">用户名</h2>
                <p id="signature">签名：这是我的签名。</p>
            </div>
        </div>
    </div>

    <div class="student-profile-body" style="width: 60%;">
        <div class="sidebar">
            <a class="sidebar-item" href="#courses">我的课程</a>
            <a class="sidebar-item" href="#courseManager">发布课程</a>
            <!-- <a class="sidebar-item" href="#exams">发布试卷</a> -->
            <a class="sidebar-item" href="#student">管理学生</a>
        </div>
        <div class="content">

            <!-- 我的课程 -->
            <div id="courses">
                <div class="tabs">
                    <a class="tabs-item" href="#courses/teach">负责课程</a>
                </div>

                <div class="tabs-content">
                </div>

            </div>

            <!-- 发布课程 -->
            <div id="courseManager">
                <div class="tabs">
                    <a class="tabs-item" href="#courseManager/courseM">新的课程</a>
                </div>

                <div class="tabs-content">
                    <div class="courseM">
                        <div class="file-part">
                            <form id="coursePublishForm">

                                <h2>课程信息</h2>
                                <div class="form-group">
                                    <label for="courseTitle">课程标题:</label>
                                    <input type="text" id="courseTitle" name="courseTitle" required>
                                    <label for="courseDescription">课程描述:</label>
                                    <textarea id="courseDescription" name="courseDescription" required></textarea>
                                    <label for="courseCategory">课程类别:</label>
                                    <select id="courseCategory" name="courseCategory" required>
                                        <option value="理学·工学">理学·工学</option>
                                        <option value="计算机">计算机</option>
                                        <option value="教育·语言">教育·语言</option>
                                        <!-- 其他课程类别 -->
                                        <option value="文学·艺术">文学·艺术</option>
                                        <option value="创业·职场">创业·职场</option>
                                        <option value="哲史·文化">哲史·文化</option>
                                        <option value="经济·管理">经济·管理</option>
                                        <option value="医学">医学</option>
                                    </select>
                                    <label for="courseIntro">课程简介:</label>
                                    <textarea id="courseIntro" name="courseIntro" required></textarea>
                                    
                                    <label>候选轮播图:</label>
                                    <div id="carouselContainer" class="carousel-container"></div>
                                    <input type="file" id="carouselImageInput" accept="image/*" multiple>
                                    <button type="button" onclick="addCarouselImages()">添加图片</button>
                                    <div class="form-group-checkbox">
                                        <label for="enableComments">打开课程评论区:</label>
                                        <input type="checkbox" id="enableComments" name="enableComments">
                                    </div>
                                    <div class="form-group-checkbox">
                                        <label for="enableNotes">打开课程笔记区域:</label>
                                        <input type="checkbox" id="enableNotes" name="enableNotes">
                                    </div>
                                </div>

                                <h2>添加课件</h2>
                                <div class="form-group">
                                    <label for="coursewareFile">上传课件:</label>
                                    <input type="file" id="coursewareFile" multiple>
                                    <button type="button" onclick="saveCourseware()">保存课件</button>
                                    <div id="courseware">
                                        <ul id="savedCoursewares"></ul>
                                    </div>
                                </div>

                                <h2>添加作业</h2>
                                <div class="form-group">
                                    <label for="assignmentTitle">作业名称:</label>
                                    <input type="text" id="assignmentTitle" name="assignmentTitle">
                                    <label for="newAssignment">作业要求:</label>
                                    <textarea id="newAssignment" name="newAssignment"></textarea>
                                    <label for="assignmentDeadline">截止日期:</label>
                                    <input type="datetime-local" id="assignmentDeadline" name="assignmentDeadline">
                                    <button type="button" onclick="addAssignment()">布置作业</button>
                                    <div id="assignmentsContainer"></div>
                                </div>

                                <div class="submit-button">
                                    <button type="button" onclick="previewCourse()">预览课程</button>
                                    <button type="button" onclick="publishCourse()">发布课程</button>
                                </div>
                            </form>
                            <br>
                            <div id="forget">
                                <h2>已发布的课程</h2>
                                <ul id="publishedCourses"></ul>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <!-- 修改 exams 部分的代码 -->
            <div id="exams">
                <div class="tabs">
                    <a id="import-exam-file" class="tabs-item active" href="#exams/import-exam-file">上传文件导入</a>
                    <a id="manual-input" class="tabs-item" href="#exams/manual-input">手动录入</a>
                </div>
                <div class="tabs-content">
                    <!-- 上传文件导入区域 -->
                    <div class="import-exam-file" style="display: block;">
                        <div class="upload-area">
                            <img src="images/upload.png" alt="上传图片">
                            <p class="upload-text">拖放文件到此处或点击上传</p>
                            <p class="upload-hint">支持 Excel (.xlsx, .xls) 或 JSON 格式</p>
                            <input type="file" id="examFileInput" accept=".xlsx,.xls,.json" />
                            <div class="file-info" id="fileInfo"></div>
                        </div>
                        <div class="exam-preview" id="examPreview" style="display: none;">
                            <h3>试卷预览</h3>
                            <div id="previewContent"></div>
                            <div class="publish-actions">
                                <button class="btn-cancel" onclick="cancelUpload()">取消</button>
                                <button class="btn-publish" onclick="publishExam()">发布试卷</button>
                            </div>
                        </div>
                    </div>

                    <!-- 手动录入区域 -->
                    <div class="manual-input" style="display: none;">
                        <div class="manual-entry-form">
                            <h3>手动录入试题</h3>
                            <form id="manualExamForm">
                                <div class="form-group">
                                    <label for="examTitle">试卷标题:</label>
                                    <input type="text" id="examTitle" required>
                                </div>
                                <div class="form-group">
                                    <label for="examDuration">考试时长(分钟):</label>
                                    <input type="number" id="examDuration" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label for="examTotalScore">总分:</label>
                                    <input type="number" id="examTotalScore" min="1" required>
                                </div>
                                <div class="question-list" id="questionList"></div>
                                <button type="button" class="btn-add-question" onclick="addQuestion()">添加试题</button>
                                <div class="publish-actions">
                                    <button type="button" class="btn-preview" onclick="previewManualExam()">预览</button>
                                    <button type="button" class="btn-publish" onclick="publishManualExam()">发布试卷</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>


            <!-- 我的学生 -->
            <div id="student">
                <div class="tabs">
                    <a class="tabs-item" href="#student/account">学生账户</a>
                </div>
                <div class="tabs-content">
                    <div class="account">
                        <div class="switch-section">
                            <span class="switch-info">学生自主注册</span>
                            <label class="switch">
                                <input type="checkbox">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>学号</th>
                                    <th>姓名</th>
                                    <th>性别</th>
                                    <th>手机号码</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 学生数据 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <!-- 页脚 -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-logo">
                <a href="#home"><img src="../header-footer/images/logo.png" alt="优课联盟"></a>
            </div>
            <div class="footer-text">
                <nav class="footer-nav">
                    <ul>
                        <li><a href="../Homepage/about.html">关于我们</a></li>
                        <li><a href="../Homepage/contact.html">联系我们</a></li>
                        <li><a href="../Homepage/privacy.html">隐私政策</a></li>
                        <li><a href="../Homepage/terms.html">服务条款</a></li>
                    </ul>
                </nav>
                <div class="footer-info">
                    <p>&copy; 2025 优课联盟. 保留所有权利.</p>
                </div>
            </div>
        </div>
    </footer>
    <script src="../database.js"></script>
    <script src="../account/account.js"></script>
    <script src="../teacher/teacher-profile-body.js"></script>
    <!-- <script src="../teacher/teacher-profile-database.js"></script> -->
    <script src="courseManager.js"></script>
    <!--页眉js-->
    <script>
        //根据token获取用户信息
        window.onload = function () {
            const userid = localStorage.getItem('token');
            //如果有用户登录，在info的div中显示用户头像，如果没用，显示登录注册按钮
            if (userid) {
                const user = JSON.parse(localStorage.getItem(userid));
                let profileUrl = '';
                let profileName = '';
                let accountUrl = '';
                if (userid === 'admin') {
                    profileUrl = '../account/admin-profile.html';
                    profileName = '个人中心';
                    accountUrl = '../account/admin-profile.html';
                } else if (userid === 'teacher') {
                    profileUrl = '../teacher/teacher-profile.html';
                    profileName = '个人中心';
                    accountUrl = '../teacher/teacher-profile.html';
                } else {
                    profileUrl = '../student/student-profile.html';
                    profileName = '我的学习';
                    accountUrl = '../account/student-setting.html';
                }
                document.querySelector('.info').innerHTML = `
                    <div id="user-menu-trigger" style="cursor: pointer;">
                        <img id="user-head" src="${user.avatar}" alt="用户头像">
                    </div>
                    <div class="card" id="user-dropdown">
                        <ul>
                            <li><a href="${profileUrl}">${profileName}</a></li>
                            <li><a href="${accountUrl}">账号设置</a></li>
                            <li><a id="logout" href="#logout">退出登录</a></li>
                        </ul>
                    </div>
                `;
                //如果点击退出登录，清除token
                document.getElementById('logout').addEventListener('click', () => {
                    localStorage.removeItem('token');
                    window.location.href = '../Homepage/WebsiteHomepage.html';
                });

                // 添加点击头像显示下拉菜单的功能
                const userMenuTrigger = document.getElementById('user-menu-trigger');
                const userDropdown = document.getElementById('user-dropdown');
                
                if (userMenuTrigger && userDropdown) {
                    userMenuTrigger.addEventListener('click', function(e) {
                        e.preventDefault();
                        userDropdown.style.display = userDropdown.style.display === 'block' ? 'none' : 'block';
                        userDropdown.style.opacity = userDropdown.style.display === 'block' ? '1' : '0';
                        userDropdown.style.transform = userDropdown.style.display === 'block' ? 'translateX(-50%) translateY(0)' : 'translateX(-50%) translateY(-10px)';
                        userDropdown.style.pointerEvents = userDropdown.style.display === 'block' ? 'auto' : 'none';
                    });

                    // 点击其他地方关闭下拉菜单
                    document.addEventListener('click', function(e) {
                        if (!userMenuTrigger.contains(e.target) && !userDropdown.contains(e.target)) {
                            userDropdown.style.display = 'none';
                            userDropdown.style.opacity = '0';
                            userDropdown.style.transform = 'translateX(-50%) translateY(-10px)';
                            userDropdown.style.pointerEvents = 'none';
                        }
                    });
                }
            }
            else {
                document.querySelector('.info').innerHTML = `
                    <a href="../account/login.html"><button class="login">登录</button></a>
                    <a href="../account/register.html"><button class="register">注册</button></a>
                `;
            }
        }
    </script>
    <!--设置访问权限,只有老师可以登录该页面-->
    <script>
        if (!localStorage.getItem('token')) {
            alert('请先登录！');
            window.location.href = '../account/login.html';
        }
        else if (localStorage.getItem('token') !== 'teacher') {
            alert('您无权访问此页面！');
            window.location.href = '../account/login.html';
        }
    </script>
    <script>
        let userid = localStorage.getItem('token');
        let user = JSON.parse(localStorage.getItem(userid));
        document.getElementById('avatar').src = user.avatar;
        document.getElementById('user-name').innerText = user.username;
        //如果签名为空，显示"还没有设置签名"
        if (user.signature === '') {
            document.getElementById('signature').innerText = '还没有设置签名';
        }
        else {
            document.getElementById('signature').innerText = '签名：' + user.signature;
        }
    </script>
    <script>
        //渲染,利用map和join方法来渲染表格
        const tbody = document.querySelector('tbody');
        function render() {
            let teacher = JSON.parse(localStorage.getItem('teacher'));
            if (teacher.allowRegister) {
                //将开关打开
                document.querySelector('.switch input').checked = true;
            }
            let students = getStudents();
            const trStu = students.map(function (student, index) {
                return `
                    <tr>
                        <td>${student.userid}</td>
                        <td>${student.username}</td>
                        <td>${student.gender}</td>
                        <td>${student.phone}</td>
                        <td>
                            <a id="reset-password" class="reset-password" href="#" 
                                data-id="${index}">重置密码</a>
                            <a id="disable" class="disable" href="#" data-id="${index}">
                                ${student.status === false ? '启用' : '禁用'}</a>
                            <a id="delete" class="delete" href="#" data-id="${index}">删除</a>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = trStu.join('');
        };
        render();
        //管理学生自主注册功能
        document.querySelector('.switch input').addEventListener('change', function (e) {
            e.preventDefault();
            const teacher = JSON.parse(localStorage.getItem('teacher'));
            teacher.allowRegister = !teacher.allowRegister;
            localStorage.setItem('teacher', JSON.stringify(teacher));
            render();
        });
        //点击重置密码、禁用/启用、删除按钮时的操作
        tbody.addEventListener('click', function (e) {
            if (e.target.id === 'reset-password') {
                resetPassword(e);
            }
            else if (e.target.id === 'disable') {
                changeStatus(e);
            }
            else if (e.target.id === 'delete') {
                deleteAccount(e);
            }
        });
        //获取localStorage中所有的值
        function getStudents() {
            var students = [];
            for (var i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                //如果key是学生的学号，就把学生信息加入students数组
                if (key.startsWith('2')) {
                    students.push(JSON.parse(localStorage.getItem(key)));
                }
            }
            return students;
        }
        //重置密码
        function resetPassword(e) {
            let students = getStudents();
            const index = e.target.dataset.id;
            const student = students[index];
            const userid = student.userid;
            student.password = simpleHash(userid, userid);//重置密码为学号
            localStorage.setItem(student.userid, JSON.stringify(student));
            render();
            alert('密码重置成功！');
        }
        //禁用/启用账号
        function changeStatus(e) {
            let students = getStudents();
            const index = e.target.dataset.id;
            const student = students[index];
            student.status = !student.status;
            localStorage.setItem(student.userid, JSON.stringify(student));
            render();
            alert(`账号已${student.status ? '启用' : '禁用'}！`);
        }
        //删除账号
        function deleteAccount(e) {
            let students = getStudents();
            const index = e.target.dataset.id;
            const student = students[index];
            if (confirm('确定删除此账号？')) {
                localStorage.removeItem(student.userid);
                render();
                alert('账号已删除！');
            }
        }
        function publishManualExam() {
    // 验证表单数据
    const examTitle = document.getElementById('examTitle').value;
    const examDuration = document.getElementById('examDuration').value;
    const examTotalScore = document.getElementById('examTotalScore').value;
    
    if (!examTitle || !examDuration || !examTotalScore) {
        alert('请填写完整的试卷信息');
        return;
    }
    
    const questions = [];
    document.querySelectorAll('.question-item').forEach(q => {
        const id = q.getAttribute('data-id');
        const type = document.getElementById(`questionType${id}`).value;
        const text = document.getElementById(`questionText${id}`).value;
        const score = document.getElementById(`questionScore${id}`).value;
        
        if (!text || !score) {
            alert(`试题 #${id} 的内容或分值未填写完整`);
            return;
        }
        
        const question = { id, type, text, score };
        
        if (type !== 'fill_blank' && type !== 'short_answer') {
            const options = [];
            q.querySelectorAll('.option-item input').forEach((input, i) => {
                options.push({
                    id: i,
                    text: input.value || `选项${String.fromCharCode(65 + i)}`
                });
            });
            question.options = options;
        }
        
        questions.push(question);
    });
    
    if (questions.length === 0) {
        alert('请至少添加一道试题');
        return;
    }
    
    // 构建试卷对象
    const examData = {
        title: examTitle,
        duration: parseInt(examDuration),
        totalScore: parseInt(examTotalScore),
        questions: questions,
        createdAt: new Date().toISOString(),
        createdBy: JSON.parse(localStorage.getItem('teacher')).username
    };
    
    // 在实际应用中，这里应该将试卷数据保存到数据库
    console.log('发布的试卷数据:', examData);
    alert('试卷发布成功！');
    
    // 重置表单
    document.getElementById('manualExamForm').reset();
    document.getElementById('questionList').innerHTML = '';
    document.getElementById('examPreview').style.display = 'none';
}

// 发布试卷函数 - 用于文件导入模式
function publishExam() {
    const examFile = document.getElementById('examFileInput').files[0];
    if (!examFile) {
        alert('请先上传试卷文件');
        return;
    }
    
    // 这里应该是实际的发布逻辑
    // 1. 解析试卷文件
    // 2. 验证试卷数据
    // 3. 保存到数据库
    // 4. 发布到学生端
    
    // 模拟试卷数据
    const examData = {
        title: "高等数学期末考试",
        totalScore: 100,
        duration: 120,
        questions: [
            {
                id: 1,
                type: "single_choice",
                text: "下列哪个是微积分基本定理的正确表述？",
                options: ["选项A", "选项B", "选项C", "选项D"],
                score: 10
            },
            {
                id: 2,
                type: "calculation",
                text: "计算定积分∫(0到π) sinx dx的值。",
                score: 20
            }
        ],
        createdAt: new Date().toISOString(),
        createdBy: JSON.parse(localStorage.getItem('teacher')).username
    };
    
    console.log('发布的试卷数据:', examData);
    alert('试卷发布成功！');
    cancelUpload();
}

// 取消上传
function cancelUpload() {
    document.getElementById('examFileInput').value = '';
    document.getElementById('fileInfo').style.display = 'none';
    document.getElementById('examPreview').style.display = 'none';
}

// 添加试题
function addQuestion() {
    const questionList = document.getElementById('questionList');
    const questionId = questionList.children.length + 1;
    
    const questionHtml = `
        <div class="question-item" data-id="${questionId}">
            <h4>试题 #${questionId}</h4>
            <div class="form-group">
                <label for="questionType${questionId}">题型:</label>
                <select id="questionType${questionId}" onchange="changeQuestionType(${questionId})">
                    <option value="single_choice">单选题</option>
                    <option value="multiple_choice">多选题</option>
                    <option value="true_false">判断题</option>
                    <option value="fill_blank">填空题</option>
                    <option value="short_answer">简答题</option>
                </select>
            </div>
            <div class="form-group">
                <label for="questionText${questionId}">题目内容:</label>
                <textarea id="questionText${questionId}" required></textarea>
            </div>
            <div class="form-group" id="optionsContainer${questionId}">
                <label>选项:</label>
                <div class="option-item">
                    <input type="text" placeholder="选项A">
                    <button type="button" onclick="removeOption(this)">删除</button>
                </div>
                <button type="button" onclick="addOption(${questionId})">添加选项</button>
            </div>
            <div class="form-group">
                <label for="questionScore${questionId}">分值:</label>
                <input type="number" id="questionScore${questionId}" min="1" value="10" required>
            </div>
            <button type="button" class="btn-remove-question" onclick="removeQuestion(${questionId})">删除此题</button>
        </div>
    `;
    
    questionList.insertAdjacentHTML('beforeend', questionHtml);
}

// 改变试题类型
function changeQuestionType(questionId) {
    const type = document.getElementById(`questionType${questionId}`).value;
    const optionsContainer = document.getElementById(`optionsContainer${questionId}`);
    
    if (type === 'fill_blank' || type === 'short_answer') {
        optionsContainer.style.display = 'none';
    } else {
        optionsContainer.style.display = 'block';
    }
}

// 添加选项
function addOption(questionId) {
    const optionsContainer = document.getElementById(`optionsContainer${questionId}`);
    const optionCount = optionsContainer.querySelectorAll('.option-item').length;
    const nextChar = String.fromCharCode(65 + optionCount);
    
    const optionHtml = `
        <div class="option-item">
            <input type="text" placeholder="选项${nextChar}">
            <button type="button" onclick="removeOption(this)">删除</button>
        </div>
    `;
    
    optionsContainer.insertAdjacentHTML('beforeend', optionHtml);
}

// 删除选项
function removeOption(button) {
    button.parentElement.remove();
}

// 删除试题
function removeQuestion(questionId) {
    document.querySelector(`.question-item[data-id="${questionId}"]`).remove();
    // 重新编号剩余的问题
    const questions = document.querySelectorAll('.question-item');
    questions.forEach((q, i) => {
        q.setAttribute('data-id', i + 1);
        q.querySelector('h4').textContent = `试题 #${i + 1}`;
    });
}

// 预览手动录入的试卷
function previewManualExam() {
    // 收集表单数据并生成预览
    const examTitle = document.getElementById('examTitle').value;
    const examDuration = document.getElementById('examDuration').value;
    const examTotalScore = document.getElementById('examTotalScore').value;
    
    if (!examTitle || !examDuration || !examTotalScore) {
        alert('请填写完整的试卷信息');
        return;
    }
    
    const questions = [];
    document.querySelectorAll('.question-item').forEach(q => {
        const id = q.getAttribute('data-id');
        const type = document.getElementById(`questionType${id}`).value;
        const text = document.getElementById(`questionText${id}`).value;
        const score = document.getElementById(`questionScore${id}`).value;
        
        if (!text || !score) {
            alert(`试题 #${id} 的内容或分值未填写完整`);
            return;
        }
        
        const question = { id, type, text, score };
        
        if (type !== 'fill_blank' && type !== 'short_answer') {
            const options = [];
            q.querySelectorAll('.option-item input').forEach((input, i) => {
                options.push({
                    id: i,
                    text: input.value || `选项${String.fromCharCode(65 + i)}`
                });
            });
            question.options = options;
        }
        
        questions.push(question);
    });
    
    if (questions.length === 0) {
        alert('请至少添加一道试题');
        return;
    }
    
    // 显示预览
    const previewContent = document.getElementById('previewContent');
    previewContent.innerHTML = `
        <h4>${examTitle}</h4>
        <p><strong>总分:</strong> ${examTotalScore}分</p>
        <p><strong>时长:</strong> ${examDuration}分钟</p>
        <div class="questions-preview">
            <h5>试题列表:</h5>
            <ol>
                ${questions.map(q => `
                    <li>
                        <p><strong>${q.text}</strong> (${q.score}分)</p>
                        ${q.options ? `<ul>${q.options.map(o => `<li>${o.text}</li>`).join('')}</ul>` : ''}
                    </li>
                `).join('')}
            </ol>
        </div>
    `;
    
    document.getElementById('examPreview').style.display = 'block';
}
    </script>
    
    <!-- AI助手悬浮按钮 -->
    <script src="../header-footer/ai-assistant-float.js"></script>
</body>

</html>