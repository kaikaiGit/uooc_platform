<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教师设置 - 教师模块</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="shortcut icon" href="../header-footer/images/ico.png" type="image/x-icon">
    <link rel="stylesheet" href="../header-footer/common.css">
    <link rel="stylesheet" href="account-styles.css">
    <style>
        .main-content {
            min-height: calc(100vh - 200px);
        }
        .profile-form {
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 20px;
        }
        #avatar-container {
            cursor: pointer;
            transition: opacity 0.3s;
        }
        #avatar-container:hover {
            opacity: 0.8;
        }
        #avatar-overlay {
            background: rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.3s;
        }
        #avatar-container:hover #avatar-overlay {
            opacity: 1;
        }
        .student-table {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #007bff;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .action-btn {
            margin: 0 2px;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            text-decoration: none;
        }
        .action-btn:hover {
            text-decoration: none;
        }
    </style>
</head>
<body>
    <!-- 页眉 -->
    <header class="navbar">
        <div class="nav">
            <div class="logo">
                <a href="../Homepage/WebsiteHomepage.html"><img src="../header-footer/images/logo.png" alt="优课联盟"></a>
            </div>
            <nav>
                <ul>
                    <li><a href="../Homepage/WebsiteHomepage.html">首页</a></li>
                    <li><a href="../Homepage/courseList.html">课程</a></li>
                    <li><a href="../Homepage/league.html">联盟院校</a></li>
                    <li><a href="../Homepage/about-us.html">关于我们</a></li>
                </ul>
            </nav>
        </div>
        <div class="info">
            <!-- 用户信息将通过JavaScript动态填充 -->
        </div>
    </header>

    <!-- 主体内容 -->
    <div class="container mt-5 main-content">
        <ul class="nav nav-tabs" id="teacherTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile-tab-pane" type="button" role="tab" aria-controls="profile-tab-pane" aria-selected="true">
                    <i class="bi bi-person-fill me-2"></i>个人信息
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="password-tab" data-bs-toggle="tab" data-bs-target="#password-tab-pane" type="button" role="tab" aria-controls="password-tab-pane" aria-selected="false">
                    <i class="bi bi-lock-fill me-2"></i>修改密码
                </button>
            </li>
        </ul>

        <div class="tab-content" id="teacherTabContent">
            <!-- 个人信息 -->
            <div class="tab-pane fade show active" id="profile-tab-pane" role="tabpanel" aria-labelledby="profile-tab" tabindex="0">
                <form id="profile-form" class="profile-form p-4">
                    <!-- 头像 -->
                    <div class="mb-3 row">
                        <label class="col-sm-2 col-form-label">头像</label>
                        <div id="avatar-container" class="position-relative" style="width: 100px; height: 100px;padding: 0;">
                            <img id="avatar-img" class="rounded-circle" style="width: 100%; height: 100%; object-fit: cover;">
                            <div id="avatar-overlay" class="position-absolute top-0 start-0 w-100 h-100 rounded-circle d-flex justify-content-center align-items-center">
                                <i class="bi bi-camera-fill text-white fs-3"></i>
                            </div>
                            <input type="file" id="change-avatar" style="display:none;" accept="image/*" />
                        </div>
                    </div>

                    <!-- 教师ID -->
                    <div class="mb-3 row">
                        <label for="teacher-id" class="col-sm-2 col-form-label">教师ID:</label>
                        <div class="col-sm-10">
                            <span id="teacher-id" class="form-control-plaintext"></span>
                        </div>
                    </div>

                    <!-- 姓名 -->
                    <div class="mb-3 row">
                        <label for="teacher-name" class="col-sm-2 col-form-label">* 姓名:</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="teacher-name" required>
                        </div>
                    </div>

                    <!-- 性别 -->
                    <div class="mb-3 row">
                        <label class="col-sm-2 col-form-label">* 性别:</label>
                        <div class="col-sm-10">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" id="male" type="radio" name="gender" value="男">
                                <label class="form-check-label" for="male">男</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" id="female" type="radio" name="gender" value="女">
                                <label class="form-check-label" for="female">女</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" id="private" type="radio" name="gender" value="不公开">
                                <label class="form-check-label" for="private">不公开</label>
                            </div>
                        </div>
                    </div>

                    <!-- 手机 -->
                    <div class="mb-3 row">
                        <label for="teacher-phone" class="col-sm-2 col-form-label">* 手机:</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="teacher-phone" required>
                            <span id="phone-error-message" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- 邮箱 -->
                    <div class="mb-3 row">
                        <label for="teacher-email" class="col-sm-2 col-form-label">邮箱:</label>
                        <div class="col-sm-10">
                            <input type="email" class="form-control" id="teacher-email">
                            <span id="email-error-message" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- 所属院校 -->
                    <div class="mb-3 row">
                        <label for="teacher-school" class="col-sm-2 col-form-label">所属院校:</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="teacher-school">
                        </div>
                    </div>

                    <!-- 学科专业 -->
                    <div class="mb-3 row">
                        <label for="teacher-subject" class="col-sm-2 col-form-label">学科专业:</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="teacher-subject">
                        </div>
                    </div>

                    <!-- 个人简介 -->
                    <div class="mb-3 row">
                        <label for="teacher-bio" class="col-sm-2 col-form-label">个人简介:</label>
                        <div class="col-sm-10">
                            <textarea class="form-control" id="teacher-bio" rows="4" placeholder="请输入个人简介"></textarea>
                        </div>
                    </div>

                    <!-- 保存按钮 -->
                    <div class="mb-3 row">
                        <div class="col-sm-10 offset-sm-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-2"></i>保存
                            </button>
                            <div id="profile-success-message" class="mt-3 alert alert-success" style="display: none;"></div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- 修改密码 -->
            <div class="tab-pane fade" id="password-tab-pane" role="tabpanel" aria-labelledby="password-tab" tabindex="0">
                <form id="reset-password-form" class="profile-form p-4">
                    <div class="mb-3 row">
                        <label for="old-password" class="col-sm-3 col-form-label">原密码:</label>
                        <div class="col-sm-9">
                            <input type="password" class="form-control" id="old-password" placeholder="输入原密码" required>
                            <span id="old-password-error" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="new-password" class="col-sm-3 col-form-label">新密码:</label>
                        <div class="col-sm-9">
                            <input type="password" class="form-control" id="new-password" placeholder="输入新密码" required>
                            <span id="new-password-error" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="confirm-new-password" class="col-sm-3 col-form-label">确认新密码:</label>
                        <div class="col-sm-9">
                            <input type="password" class="form-control" id="confirm-new-password" placeholder="再次输入新密码" required>
                            <span id="confirm-password-error" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <div class="col-sm-9 offset-sm-3">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-shield-check me-2"></i>确认修改
                            </button>
                            <div id="password-success-message" class="mt-3 alert alert-success" style="display: none;"></div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="footer mt-5">
        <div class="footer-content">
            <div class="footer-logo">
                <a href="../Homepage/WebsiteHomepage.html"><img src="../header-footer/images/logo.png" alt="优课联盟"></a>
            </div>
            <div class="footer-text">
                <nav class="footer-nav">
                    <ul>
                        <li><a href="../Homepage/about-us.html">关于我们</a></li>
                        <li><a href="../Homepage/contact.html">联系我们</a></li>
                        <li><a href="../Homepage/privacy.html">隐私政策</a></li>
                        <li><a href="../Homepage/terms.html">服务条款</a></li>
                    </ul>
                </nav>
                <div class="footer-info">
                    <p>&copy; 2025 优课联盟. 保留所有权利.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="../database.js"></script>
    <script src="account.js"></script>
    
    <!-- 页面初始化脚本 -->
    <script>
        // 页面加载时初始化用户信息
        window.onload = function() {
            initializeUserInfo();
            initializeTeacherProfile();
            loadStudentData();
        }

        // 初始化用户信息显示
        function initializeUserInfo() {
            const userid = localStorage.getItem('token');
            if(userid) {
                const user = JSON.parse(localStorage.getItem(userid));
                document.querySelector('.info').innerHTML = `
                    <a href="../teacher/teacher-profile.html"><img id="user-head" src="${user.avatar}" alt="用户头像"></a>
                    <div class="card">
                        <ul>
                            <li><a href="../teacher/teacher-profile.html">我的教学</a></li>
                            <li><a href="../account/teacher-setting.html">账号设置</a></li>
                            <li><a id="logout" href="#logout">退出登录</a></li>
                        </ul>
                    </div>
                `;
                // 退出登录功能
                document.getElementById('logout').addEventListener('click', () => {
                    localStorage.removeItem('token');
                    window.location.href = '../Homepage/WebsiteHomepage.html';
                });
            } else {
                document.querySelector('.info').innerHTML = `
                    <a href="../account/login.html"><button class="login">登录</button></a>
                    <a href="../account/register.html"><button class="register">注册</button></a>
                `;
                // 如果没有登录，跳转到登录页面
                alert('请先登录！');
                window.location.href = '../account/login.html';
            }
        }

        // 初始化教师个人信息
        function initializeTeacherProfile() {
            const userid = localStorage.getItem('token');
            if(!userid) return;
            
            const teacher = JSON.parse(localStorage.getItem(userid));
            if(!teacher) return;

            // 填充个人信息表单
            document.getElementById('avatar-img').src = teacher.avatar || '../header-footer/images/user-head.jpg';
            document.getElementById('teacher-id').textContent = teacher.userid;
            document.getElementById('teacher-name').value = teacher.username || '';
            
            // 设置性别单选框
            if(teacher.gender === '男') {
                document.getElementById('male').checked = true;
            } else if(teacher.gender === '女') {
                document.getElementById('female').checked = true;
            } else {
                document.getElementById('private').checked = true;
            }
            
            document.getElementById('teacher-phone').value = teacher.phone || '';
            document.getElementById('teacher-email').value = teacher.email || '';
            document.getElementById('teacher-school').value = teacher.school || '';
            document.getElementById('teacher-subject').value = teacher.subject || '';
            document.getElementById('teacher-bio').value = teacher.bio || '';
            
            // 设置学生注册开关
            document.getElementById('allow-register').checked = teacher.allowRegister || false;
        }

        // 加载学生数据
        function loadStudentData() {
            const students = getStudents();
            renderStudentTable(students);
        }

        // 获取所有学生数据
        function getStudents() {
            const students = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('2')) { // 学生ID以2开头
                    const student = JSON.parse(localStorage.getItem(key));
                    if(student && student.userType === 'student') {
                        students.push(student);
                    }
                }
            }
            return students;
        }

        // 渲染学生表格
        function renderStudentTable(students) {
            const tbody = document.getElementById('students-tbody');
            const noStudents = document.getElementById('no-students');
            
            if(students.length === 0) {
                tbody.innerHTML = '';
                noStudents.style.display = 'block';
                return;
            }
            
            noStudents.style.display = 'none';
            const rows = students.map((student, index) => {
                const statusBadge = student.status !== false ? 
                    '<span class="badge bg-success">正常</span>' : 
                    '<span class="badge bg-danger">禁用</span>';
                    
                return `
                    <tr>
                        <td>${student.userid}</td>
                        <td>${student.username}</td>
                        <td>${student.gender || '未知'}</td>
                        <td>${student.phone || '未填写'}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-warning action-btn" onclick="resetStudentPassword('${student.userid}')">
                                <i class="bi bi-key"></i> 重置密码
                            </button>
                            <button class="btn btn-sm btn-outline-${student.status !== false ? 'secondary' : 'success'} action-btn" onclick="toggleStudentStatus('${student.userid}')">
                                <i class="bi bi-toggle-${student.status !== false ? 'off' : 'on'}"></i> ${student.status !== false ? '禁用' : '启用'}
                            </button>
                            <button class="btn btn-sm btn-outline-danger action-btn" onclick="deleteStudent('${student.userid}')">
                                <i class="bi bi-trash"></i> 删除
                            </button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = rows.join('');
        }

        // 重置学生密码
        function resetStudentPassword(studentId) {
            if(!confirm('确定要重置该学生的密码吗？密码将重置为学号。')) return;
            
            const student = JSON.parse(localStorage.getItem(studentId));
            if(student) {
                student.password = simpleHash(studentId, studentId); // 密码重置为学号
                localStorage.setItem(studentId, JSON.stringify(student));
                showAlert('密码重置成功！新密码为学号。', 'success');
                loadStudentData();
            }
        }

        // 切换学生状态
        function toggleStudentStatus(studentId) {
            const student = JSON.parse(localStorage.getItem(studentId));
            if(student) {
                student.status = !student.status;
                localStorage.setItem(studentId, JSON.stringify(student));
                showAlert(`学生账号已${student.status ? '启用' : '禁用'}！`, 'success');
                loadStudentData();
            }
        }

        // 删除学生
        function deleteStudent(studentId) {
            if(!confirm('确定要删除该学生账号吗？此操作不可恢复！')) return;
            
            localStorage.removeItem(studentId);
            showAlert('学生账号已删除！', 'success');
            loadStudentData();
        }

        // 显示提示信息
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if(alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }
    </script>

    <!-- 个人信息表单处理脚本 -->
    <script>
        // 头像上传功能
        document.getElementById('avatar-container').addEventListener('click', () => {
            document.getElementById('change-avatar').click();
        });

        document.getElementById('change-avatar').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('avatar-img').src = e.target.result;
            }
            reader.readAsDataURL(file);
        });

        // 手机号验证
        document.getElementById('teacher-phone').addEventListener('blur', () => {
            const phone = document.getElementById('teacher-phone').value;
            validatePhone(phone);
        });

        // 邮箱验证
        document.getElementById('teacher-email').addEventListener('blur', () => {
            const email = document.getElementById('teacher-email').value;
            validateEmail(email);
        });

        // 个人信息表单提交
        document.getElementById('profile-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const phone = document.getElementById('teacher-phone').value;
            const email = document.getElementById('teacher-email').value;
            
            // 验证必填字段
            if(!validatePhone(phone) || !validateEmail(email)) return;
            
            const userid = localStorage.getItem('token');
            let teacher = JSON.parse(localStorage.getItem(userid));
            
            // 更新教师信息
            teacher.avatar = document.getElementById('avatar-img').src;
            teacher.username = document.getElementById('teacher-name').value;
            teacher.gender = document.querySelector('input[name="gender"]:checked').value;
            teacher.phone = phone;
            teacher.email = email;
            teacher.school = document.getElementById('teacher-school').value;
            teacher.subject = document.getElementById('teacher-subject').value;
            teacher.bio = document.getElementById('teacher-bio').value;
            
            // 保存到localStorage
            localStorage.setItem(userid, JSON.stringify(teacher));
            
            // 显示成功消息
            const successMsg = document.getElementById('profile-success-message');
            successMsg.textContent = '个人信息保存成功！';
            successMsg.style.display = 'block';
            
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);
        });

        // 手机号验证函数
        function validatePhone(phone) {
            const phoneRegex = /^1[3-9]\d{9}$/;
            const errorElement = document.getElementById('phone-error-message');
            
            if(!phone) {
                errorElement.textContent = '手机号不能为空';
                return false;
            }
            
            if(!phoneRegex.test(phone)) {
                errorElement.textContent = '请输入正确的手机号格式';
                return false;
            }
            
            errorElement.textContent = '';
            return true;
        }

        // 邮箱验证函数
        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const errorElement = document.getElementById('email-error-message');
            
            if(email && !emailRegex.test(email)) {
                errorElement.textContent = '请输入正确的邮箱格式';
                return false;
            }
            
            errorElement.textContent = '';
            return true;
        }

        // 学生注册开关
        document.getElementById('allow-register').addEventListener('change', function() {
            const userid = localStorage.getItem('token');
            const teacher = JSON.parse(localStorage.getItem(userid));
            teacher.allowRegister = this.checked;
            localStorage.setItem(userid, JSON.stringify(teacher));
            
            showAlert(`学生自主注册已${this.checked ? '开启' : '关闭'}`, 'info');
        });
    </script>

    <!-- 密码修改脚本 -->
    <script>
        // 密码输入框验证
        document.getElementById('old-password').addEventListener('blur', validateOldPassword);
        document.getElementById('new-password').addEventListener('blur', validateNewPassword);
        document.getElementById('confirm-new-password').addEventListener('blur', validateConfirmPassword);

        // 密码修改表单提交
        document.getElementById('reset-password-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            if(!validateOldPassword() || !validateNewPassword() || !validateConfirmPassword()) {
                return;
            }
            
            const userid = localStorage.getItem('token');
            let teacher = JSON.parse(localStorage.getItem(userid));
            const oldPassword = document.getElementById('old-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            
            // 验证新密码一致性
            if(newPassword !== confirmPassword) {
                document.getElementById('confirm-password-error').textContent = '两次输入的密码不一致';
                return;
            }
            
            // 验证原密码正确性
            if(simpleHash(oldPassword, userid) !== teacher.password) {
                document.getElementById('old-password-error').textContent = '原密码错误';
                return;
            }
            
            // 更新密码
            teacher.password = simpleHash(newPassword, userid);
            localStorage.setItem(userid, JSON.stringify(teacher));
            
            // 显示成功消息
            const successMsg = document.getElementById('password-success-message');
            successMsg.textContent = '密码修改成功！请重新登录。';
            successMsg.style.display = 'block';
            
            // 清空表单
            document.getElementById('reset-password-form').reset();
            
            // 2秒后跳转到登录页面
            setTimeout(() => {
                localStorage.removeItem('token');
                window.location.href = '../account/login.html';
            }, 2000);
        });

        // 验证原密码
        function validateOldPassword() {
            const oldPassword = document.getElementById('old-password').value;
            const errorElement = document.getElementById('old-password-error');
            
            if(!oldPassword) {
                errorElement.textContent = '原密码不能为空';
                return false;
            }
            
            errorElement.textContent = '';
            return true;
        }

        // 验证新密码
        function validateNewPassword() {
            const newPassword = document.getElementById('new-password').value;
            const errorElement = document.getElementById('new-password-error');
            
            if(!newPassword) {
                errorElement.textContent = '新密码不能为空';
                return false;
            }
            
            if(newPassword.length < 6) {
                errorElement.textContent = '密码长度至少6位';
                return false;
            }
            
            errorElement.textContent = '';
            return true;
        }

        // 验证确认密码
        function validateConfirmPassword() {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            const errorElement = document.getElementById('confirm-password-error');
            
            if(!confirmPassword) {
                errorElement.textContent = '确认密码不能为空';
                return false;
            }
            
            if(newPassword !== confirmPassword) {
                errorElement.textContent = '两次输入的密码不一致';
                return false;
            }
            
            errorElement.textContent = '';
            return true;
        }
    </script>
</body>
</html>
