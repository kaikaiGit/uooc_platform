<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录</title>
    <link rel="stylesheet" href="account-login.css">

</head>
<body>
    <div class="container">
        <h2>登录</h2>
        <form id="login-form">
            <div class="input-group">
                <label for="userid">学号</label>
                <input type="text" id="userid" placeholder="学号" required>
                <span id="us-error-message" class="error-message"></span>
            </div>
            <div class="input-group">
                <label for="password">密码</label>
                <input type="password" id="password" placeholder="输入密码" required>
                <span id="pa-error-message" class="error-message"></span>
            </div>

            <button id="btn" type="submit" class="button">登录</button>
            <div id="success-message" class="success-message"></div>

            <div>
                <input type="checkbox" id="remember-me">
                <label for="remember-me">记住账号</label>
                <label>
                    <input type="checkbox" required> 我已同意 <a href="#">《隐私政策》</a>
                </label>
            </div>
        </form>
        <p>
            没有账号？<a href="register.html">注册</a> | <a href="forgot-password.html">忘记密码？</a>
        </p>
    </div>
    <script src="../database.js"></script>
    <script src="account.js"></script>
    <script>
        //检查是否记住账号,清除token
        window.onload = function() {
            const rememberMe = localStorage.getItem('rememberMe');
            if (rememberMe) {
                document.getElementById('userid').value = rememberMe;
                document.getElementById('remember-me').checked = true;
            }
            localStorage.removeItem('token');
        }
        //当离开用户id输入框时，验证是否填写用户id
        document.getElementById('userid').addEventListener('blur', () => {
            checkUserid();
        });
        //当离开密码输入框时，验证是否填写密码
        document.getElementById('password').addEventListener('blur', () => {
            checkPassword();
        });
        let errorCount = 0;//错误次数计数器
        const maxErrors = 5;//最大错误次数
        let freezeTime = 5000;//冻结5s
        //当点击登录按钮时，验证密码是否填写
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const userid = document.getElementById('userid').value;
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            //验证是否填写信息
            if (!checkUserid() || !checkPassword()) {
                return;
            }
            //检验用户id是否存在
            const item = JSON.parse(localStorage.getItem(userid));
            if (!item) {
                document.getElementById('us-error-message').textContent = '用户id不存在';
                return;
            }
            document.getElementById('us-error-message').textContent = '';
            //根据localstorage判断密码是否正确
            if(!isCorrect(password, userid, item.password)){
                document.getElementById('pa-error-message').textContent = '密码错误,错误5次后将冻结账户'+freezeTime/1000+'s';
                document.getElementById('password').value = '';
                errorCount++;
                //错误次数达到5次后冻结账户
                if(errorCount >= maxErrors){
                    //输出错误信息
                    alert('账户已冻结，请稍后再试');
                    document.getElementById('btn').disabled = true;
                    document.getElementById('login-form').disabled = true;
                    setTimeout(() => {
                        document.getElementById('btn').disabled = false;
                        document.getElementById('login-form').disabled = false;
                        errorCount = 0;
                    }, freezeTime);
                    freezeTime *= 2;//冻结时间翻倍
                }
                return;
            }
            //清空错误信息
            document.getElementById('us-error-message').textContent = '';
            document.getElementById('pa-error-message').textContent = '';
            //检验账号状态
            if(!item.status){
                alert('账号已被禁用, 请联系老师');
                return;
            }
            //登录成功
            document.getElementById('success-message').textContent = '登录成功！';
            //重置错误次数和冻结时间
            errorCount = 0;
            freezeTime = 5000;
            //记录当前登录的用户id
            localStorage.setItem('token', userid);
            //检测是否勾选记住账号
            if (rememberMe) {
                localStorage.setItem('rememberMe', userid);
            }
            else {
                localStorage.removeItem('rememberMe');
            }
            //1s后根据identity跳转到不同界面
            setTimeout(() => {
                if(item.identity === 'student'){
                    window.location.href = '../student/student-profile.html';
                }
                else if(item.identity === 'teacher'){
                    window.location.href = '../teacher/teacher-profile.html';
                }
                else if(item.identity === 'admin'){
                    window.location.href = '../account/admin-profile.html';
                }
            }, 1000);
        });
        //重写checkPassword函数,不检验密码格式
        function checkPassword() {
            const password = document.getElementById('password').value;
            if (!password) {
                document.getElementById('pa-error-message').textContent = '请输入密码';
                return false;
            }
            document.getElementById('pa-error-message').textContent = '';
            return true;
        }
        //验证密码是否正确
        function isCorrect(password, userid, tPassword) {
            //根据localstorage判断密码是否正确
            password = simpleHash(password, userid);
            if(password !== tPassword){
                return false;
            }
            return true;
        }
    </script>
</body>
</html>
