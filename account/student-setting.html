<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修改个人资料</title>
    <link rel="stylesheet" href="../Homepage/css/header.css">
    <link rel="shortcut icon" href="../header-footer/images/ico.png" type="image/x-icon">
    <link rel="stylesheet" href="../Homepage/css/header.css">
    <link rel="stylesheet" href="../header-footer/common.css">
    <link rel="stylesheet" href="account-styles.css">
    <link rel="stylesheet" href="../student/student-profile.css">
</head>
<body>
    <!-- 页眉 -->
    <header class="navbar">
        <div class="nav">
            <div class="logo">
                <a href="../Homepage/WebsiteHomepage.html"><img src="../header-footer/images/logo.png" alt="优课联盟"></a>
            </div>
            <nav>
                <ul>
                    <!-- TODO 补充链接 -->
                    <li><a href="../Homepage/WebsiteHomepage.html">首页</a></li>
                    <li><a href="../Homepage/courseList.html">课程</a></li>
                    <li><a href="#league">联盟院校</a></li>
                    <li><a href="#about-us">关于我们</a></li>
                </ul>
            </nav>
        </div>
        
        <div class="info">
            <!-- TODO 补充链接 -->
        </div>
    </header>
    <!-- 主体内容 -->
    <div class="profile-container">
        <!-- Tabs -->
        <div class="tabs">
            <a class="tabs-item" href="">基本信息</a>
            <a class="tabs-item" href="">修改密码</a>
        </div>
        <!-- 基本信息 -->
        <div class="tabs-content">
            <!-- Form Section -->
            <form id="profile-form" class="profile-form">
                <!-- 头像 -->
                <div class="avatar-section">
                    <a id="edit-avatar" href="#"><img id="avatar-img"></a>
                    <a id="change-avatar-text" href="#">更换头像</a>
                    <input type="file" id="change-avatar" style="display:none;" />
                </div>
        
                <!--用户id-->
                <div class="userid-section">
                    <label for="userid">用户ID:</label>
                    <span id="userid"></span>
                </div>
                <!-- 昵称 -->
                <div class="username-section">
                    <label for="username">* 昵称:</label>
                    <input type="text" id="username" required>
                </div>
                <!-- 性别 -->
                <div class="gender-section">
                    <label>* 性别:</label>
                    <label><input id="man" type="radio" name="gender" value="男"> 男</label>
                    <label><input id="woman" type="radio" name="gender" value="女"> 女</label>
                    <label><input id="unknown" type="radio" name="gender" value="不公开"> 不公开</label>
                </div>
                <!-- 手机 -->
                <div class="phone-section">
                    <label for="phone">* 手机:</label>
                    <input type="text" id="phone" required>
                    <span id="ph-error-message" class="error-message"></span>
                    <!-- <span id="phone"></span>
                    <a href="#" class="edit-link">修改手机</a>
                    <a href="#" class="unbind-link">解除绑定</a> -->
                </div>
                <!-- 签名档 -->
                <div class="signature-section">
                    <label for="signature">签名档:</label>
                    <textarea id="signature" placeholder="请输入签名档"></textarea>
                </div>
                <!-- 保存按钮 -->
                <button type="submit" class="save-button">保存</button>
                <div id="success-message" class="success-message"></div>
            </form>
        </div>
        <!-- 修改密码 -->
        <div class="tabs-content">
            <form id="reset-password-form" class="profile-form">
                <div class="password-section">
                    <label for="old-password">原密码:</label>
                    <input type="password" id="old-password" placeholder="输入原密码" required>
                    <span id="op-error-message" class="error-message"></span>
                </div>
                <div class="password-section">
                    <label for="password">新密码:</label>
                    <input type="password" id="password" placeholder="输入新密码" required>
                    <span id="pa-error-message" class="error-message"></span>
                </div>
                <div class="password-section">
                    <label for="confirm-password">确认新密码:</label>
                    <input type="password" id="confirm-password" placeholder="再次输入新密码" required>
                    <span id="cp-error-message" class="error-message"></span>
                </div>
                <button type="submit" class="confirm-button">确认</button>
                <div id="success-message" class="success-message"></div>
            </form>
        </div>
    </div>
    <!-- 页脚 -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-logo">
                <a href="#home"><img src="../header-footer/images/logo.png" alt="优课联盟"></a>
            </div>
            <div class="footer-text">
                <nav class="footer-nav">
                    <ul>
                        <li><a href="#about">关于我们</a></li>
                        <li><a href="#contact">联系我们</a></li>
                        <li><a href="#privacy">隐私政策</a></li>
                        <li><a href="#terms">服务条款</a></li>
                    </ul>
                </nav>
                <div class="footer-info">
                    <p>&copy; 2024 优课联盟. 保留所有权利.</p>
                </div>
            </div>
        </div>
    </footer>
    <script src="../database.js"></script>
    <script src="../account/account.js"></script>
    <script>
        //根据token获取用户信息
        window.onload = function() {
            const userid = localStorage.getItem('token');
            //如果有用户登录，在info的div中显示用户头像，如果没用，显示登录注册按钮
            if(userid) {
                const user = JSON.parse(localStorage.getItem(userid));
                document.querySelector('.info').innerHTML = `
                    <a href="../student/student-profile.html"><img id="user-head" src="${user.avatar}" alt="用户头像"></a>
                    <div class="card">
                        <ul>
                            <li><a href="../student/student-profile.html">我的学习</a></li>
                            <li><a href="../account/student-setting.html">账号设置</a></li>
                            <li><a id="logout" href="#logout">退出登录</a></li>
                        </ul>
                    </div>
                `;
                //如果点击退出登录，清除token
                document.getElementById('logout').addEventListener('click', () => {
                    localStorage.removeItem('token');
                    window.location.href = '../Homepage/WebsiteHomepage.html';
                });
            }
            else{
                document.querySelector('.info').innerHTML = `
                    <a href="../account/login.html"><button class="login">登录</button></a>
                    <a href="../account/register.html"><button class="register">注册</button></a>
                `;
            }
        }
    </script>
    <!--主体内容初始化-->
    <script>
        //默认选中第一个tab
        document.querySelector('.tabs-item').classList.add('active');
        document.querySelectorAll('.tabs-content')[0].style.display = 'block';
        document.querySelectorAll('.tabs-content')[1].style.display = 'none';
        const userid = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem(userid));
        const gender = user.gender;
        const signature = user.signature;
        document.getElementById('avatar-img').src = user.avatar;
        document.getElementById('userid').textContent = user.userid;
        document.getElementById('username').value = user.username;
        if(gender === '不公开') document.getElementById('unknown').checked = true;
        else if(gender === '男') document.getElementById('man').checked = true;
        else document.getElementById('woman').checked = true;
        document.getElementById('phone').value = user.phone;
        if(signature) document.getElementById('signature').textContent = signature;
    </script>
    <script>
        //点击tab切换
        document.addEventListener('DOMContentLoaded', () => {
            let tabs = document.querySelectorAll('.tabs-item');
            let tabContents = document.querySelectorAll('.tabs-content');
            tabs.forEach((tab, index) => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    // 移除所有tabs的active类
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.style.display = 'none');
                    // 为当前点击的tab添加active类
                    tab.classList.add('active');
                    tabContents[index].style.display = 'block';
                });
            });
        });
        //点击更换头像
        document.getElementById('change-avatar-text').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('change-avatar').click();
        });
        document.getElementById('change-avatar').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('avatar-img').src = e.target.result;
            }
            reader.readAsDataURL(file);
        });
        //离开手机号输入框时验证手机号
        document.getElementById('phone').addEventListener('blur', () => {
            const phone = document.getElementById('phone').value;
            checkPhone(phone);
        });
        //保存按钮点击事件
        document.getElementById('profile-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const userid = localStorage.getItem('token');
            let user = JSON.parse(localStorage.getItem(userid));
            const phone = document.getElementById('phone').value;
            //验证手机号
            if(!checkPhone(phone)) return;
            //更新用户信息
            user.avatar = document.getElementById('avatar-img').src;
            user.username = document.getElementById('username').value;
            if(document.getElementById('man').checked) user.gender = '男';
            else if(document.getElementById('woman').checked) user.gender = '女';
            else if(document.getElementById('unknown').checked) user.gender = '不公开';
            user.phone = phone;
            user.signature = document.getElementById('signature').value;
            //更新localstorage
            localStorage.setItem(userid, JSON.stringify(user));
            //提示保存成功
            document.querySelectorAll('#success-message')[0].textContent = '保存成功！';
            //1s后更新页面
            setTimeout(() => {
                location.reload();
            }, 1000);
        });

        //离开原密码输入框时验证原密码
        document.getElementById('old-password').addEventListener('blur', () => {
            checkOldPassword();
        });
        //离开新密码输入框时验证新密码
        document.getElementById('password').addEventListener('blur', () => {
            checkPassword();
        });
        //离开确认密码输入框时验证确认密码
        document.getElementById('confirm-password').addEventListener('blur', () => {
            checkConfirmPassword();
        });
        //确认按钮点击事件
        document.getElementById('reset-password-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const userid = localStorage.getItem('token');
            let user = JSON.parse(localStorage.getItem(userid));
            const oldPassword = document.getElementById('old-password').value;
            let password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            //验证信息是否填写完整
            if(!checkOldPassword() || !checkPassword() || !checkConfirmPassword()) return;
            //验证新密码和确认密码是否一致
            if(password !== confirmPassword) {
                document.getElementById('cp-error-message').textContent = '密码不一致，请重新输入';
                //清空密码输入框
                document.getElementById('old-password').value = '';
                document.getElementById('password').value = '';
                document.getElementById('confirm-password').value = '';
                return;
            }
            //验证原密码是否正确
            if(simpleHash(oldPassword, userid) !== user.password) {
                document.getElementById('op-error-message').textContent = '原密码错误';
                //清空密码输入框
                document.getElementById('old-password').value = '';
                document.getElementById('password').value = '';
                document.getElementById('confirm-password').value = '';
                return;
            }
            //更新密码
            password = simpleHash(password, userid);
            user.password = password;
            //更新localstorage
            localStorage.setItem(userid, JSON.stringify(user));
            //提示保存成功
            document.querySelectorAll('#success-message')[1].textContent = '密码修改成功！';
            //2s后跳转到登录页面
            setTimeout(() => {
                window.location.href = '../account/login.html';
            }, 2000);
        });
        //验证是否填写密码
        function checkOldPassword() {
            const oldPassword = document.getElementById('old-password').value;
            if(!oldPassword) {
                document.getElementById('op-error-message').textContent = '原密码不能为空';
                return false;
            }
            else {
                document.getElementById('op-error-message').textContent = '';
                return true;
            }
        }
    </script>
</body>
</html>
