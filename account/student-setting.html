<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="../Homepage/css/header.css">
    <link rel="shortcut icon" href="../header-footer/images/ico.png" type="image/x-icon">
    <link rel="stylesheet" href="../Homepage/css/header.css">
    <link rel="stylesheet" href="../header-footer/common.css">
    <!-- <link rel="stylesheet" href="new-student-setting.css"> -->
    <link rel="stylesheet" href="account-styles.css">
</head>
<body>
    <!-- Header -->
    <header class="navbar">
        <div class="nav">
            <div class="logo">
                <a href="../Homepage/WebsiteHomepage.html"><img src="../header-footer/images/logo.png" alt="UOOC Alliance"></a>
            </div>
            <nav>
                <ul>
                    <!-- TODO Add links -->
                    <li><a href="../Homepage/WebsiteHomepage.html">Home</a></li>
                    <li><a href="../Homepage/courseList.html">Courses</a></li>
                    <li><a href="../Homepage/league.html">Alliance Universities</a></li>
                    <li><a href="../Homepage/about-us.html">About Us</a></li>
                </ul>
            </nav>
        </div>
        
        <div class="info">
            <!-- TODO Add links -->
        </div>
    </header>
    <!-- Main Content -->
    <div class="container mt-5 main-content">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-tab-pane" type="button" role="tab" aria-controls="info-tab-pane" aria-selected="true">Basic Info</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="password-tab" data-bs-toggle="tab" data-bs-target="#password-tab-pane" type="button" role="tab" aria-controls="password-tab-pane" aria-selected="false">Change Password</button>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">
            <!-- Basic Info -->
            <div class="tab-pane fade show active" id="info-tab-pane" role="tabpanel" aria-labelledby="info-tab" tabindex="0">
                <form id="profile-form" class="profile-form p-4">
                    <!-- Avatar -->
                    <div class="mb-3 row">
                        <label class="col-sm-2 col-form-label">Avatar</label>
                        <div id="avatar-container" class="position-relative" style="width: 100px; height: 100px;padding: 0;">
                            <img id="avatar-img" class="rounded-circle" style="width: 100%; height: 100%; object-fit: cover;">
                            <div id="avatar-overlay" class="position-absolute top-0 start-0 w-100 h-100 rounded-circle d-flex justify-content-center align-items-center">
                                <i class="bi bi-camera-fill text-white fs-3"></i>
                            </div>
                            <input type="file" id="change-avatar" style="display:none;" accept="image/*" />
                        </div>
                    </div>
            
                    <!-- User ID -->
                    <div class="mb-3 row">
                        <label for="userid" class="col-sm-2 col-form-label">User ID:</label>
                        <div class="col-sm-10">
                            <span id="userid" class="form-control-plaintext"></span>
                        </div>
                    </div>
                    <!-- Nickname -->
                    <div class="mb-3 row">
                        <label for="username" class="col-sm-2 col-form-label">* Nickname:</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="username" required>
                        </div>
                    </div>
                    <!-- Gender -->
                    <div class="mb-3 row">
                        <label class="col-sm-2 col-form-label">* Gender:</label>
                        <div class="col-sm-10">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" id="man" type="radio" name="gender" value="Male">
                                <label class="form-check-label" for="man">Male</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" id="woman" type="radio" name="gender" value="Female">
                                <label class="form-check-label" for="woman">Female</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" id="unknown" type="radio" name="gender" value="Prefer not to say">
                                <label class="form-check-label" for="unknown">Prefer not to say</label>
                            </div>
                        </div>
                    </div>
                    <!-- Phone -->
                    <div class="mb-3 row">
                        <label for="phone" class="col-sm-2 col-form-label">* Phone:</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="phone" required>
                            <span id="ph-error-message" class="text-danger"></span>
                        </div>
                    </div>
                    <!-- Signature -->
                    <div class="mb-3 row">
                        <label for="signature" class="col-sm-2 col-form-label">Signature:</label>
                        <div class="col-sm-10">
                            <textarea class="form-control" id="signature" placeholder="Enter your signature"></textarea>
                        </div>
                    </div>
                    <!-- Save Button -->
                    <div class="mb-3 row">
                        <div class="col-sm-10 offset-sm-2">
                            <button type="submit" class="btn btn-primary">Save</button>
                            <div id="success-message" class="mt-3 alert alert-success" style="display: none;"></div>
                        </div>
                    </div>
                </form>
            </div>
            <!-- Change Password -->
            <div class="tab-pane fade" id="password-tab-pane" role="tabpanel" aria-labelledby="password-tab" tabindex="0">
                <form id="reset-password-form" class="profile-form p-4">
                    <div class="mb-3 row">
                        <label for="old-password" class="col-sm-3 col-form-label">Old Password:</label>
                        <div class="col-sm-9">
                            <input type="password" class="form-control" id="old-password" placeholder="Enter old password" required>
                            <span id="op-error-message" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="password" class="col-sm-3 col-form-label">New Password:</label>
                        <div class="col-sm-9">
                            <input type="password" class="form-control" id="password" placeholder="Enter new password" required>
                            <span id="pa-error-message" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="confirm-password" class="col-sm-3 col-form-label">Confirm New Password:</label>
                        <div class="col-sm-9">
                            <input type="password" class="form-control" id="confirm-password" placeholder="Re-enter new password" required>
                            <span id="cp-error-message" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <div class="col-sm-9 offset-sm-3">
                            <button type="submit" class="btn btn-primary">Confirm</button>
                            <div id="success-message-password" class="mt-3 alert alert-success" style="display: none;"></div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Footer -->
    <footer class="footer mt-5">
        <div class="footer-content">
            <div class="footer-logo">
                <a href="#home"><img src="../header-footer/images/logo.png" alt="UOOC Alliance"></a>
            </div>
            <div class="footer-text">
                <nav class="footer-nav">
                    <ul>
                        <li><a href="#about">About Us</a></li>
                        <li><a href="#contact">Contact Us</a></li>
                        <li><a href="#privacy">Privacy Policy</a></li>
                        <li><a href="#terms">Terms of Service</a></li>
                    </ul>
                </nav>
                <div class="footer-info">
                    <p>&copy; 2025 UOOC Alliance. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="../database.js"></script>
    <script src="../account/account.js"></script>
    <script>
        // Get user info by token
        window.onload = function() {
            const userid = localStorage.getItem('token');
            // If user is logged in, show avatar in .info div, else show login/register buttons
            if(userid) {
                const user = JSON.parse(localStorage.getItem(userid));
                document.querySelector('.info').innerHTML = `
                    <a href="../student/student-profile.html"><img id="user-head" src="${user.avatar}" alt="User Avatar"></a>
                    <div class="card">
                        <ul>
                            <li><a href="../student/student-profile.html">My Learning</a></li>
                            <li><a href="../account/student-setting.html">Account Settings</a></li>
                            <li><a id="logout" href="#logout">Logout</a></li>
                        </ul>
                    </div>
                `;
                // If click logout, clear token
                document.getElementById('logout').addEventListener('click', () => {
                    localStorage.removeItem('token');
                    window.location.href = '../Homepage/WebsiteHomepage.html';
                });
            }
            else{
                document.querySelector('.info').innerHTML = `
                    <a href="../account/login.html"><button class="login">Login</button></a>
                    <a href="../account/register.html"><button class="register">Register</button></a>
                `;
            }
        }
    </script>
    <!-- Main content initialization -->
    <script>
        // Set default selected tab
        const userid = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem(userid));
        const gender = user.gender;
        const signature = user.signature;
        document.getElementById('avatar-img').src = user.avatar;
        document.getElementById('userid').textContent = user.userid;
        document.getElementById('username').value = user.username;
        if(gender === 'Prefer not to say') document.getElementById('unknown').checked = true;
        else if(gender === 'Male') document.getElementById('man').checked = true;
        else document.getElementById('woman').checked = true;
        document.getElementById('phone').value = user.phone;
        if(signature) document.getElementById('signature').value = signature;
    </script>
    <script>
        // Tab switching
        // Click to change avatar
        document.getElementById('avatar-container').addEventListener('click', () => {
            document.getElementById('change-avatar').click();
        });

        document.getElementById('change-avatar').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('avatar-img').src = e.target.result;
            }
            reader.readAsDataURL(file);
        });
        // Validate phone on blur
        document.getElementById('phone').addEventListener('blur', () => {
            const phone = document.getElementById('phone').value;
            checkPhone(phone);
        });
        // Save button click event
        document.getElementById('profile-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const userid = localStorage.getItem('token');
            let user = JSON.parse(localStorage.getItem(userid));
            const phone = document.getElementById('phone').value;
            // Validate phone
            if(!checkPhone(phone)) return;
            // Update user info
            user.avatar = document.getElementById('avatar-img').src;
            user.username = document.getElementById('username').value;
            if(document.getElementById('man').checked) user.gender = 'Male';
            else if(document.getElementById('woman').checked) user.gender = 'Female';
            else if(document.getElementById('unknown').checked) user.gender = 'Prefer not to say';
            user.phone = phone;
            user.signature = document.getElementById('signature').value;
            // Update localstorage
            localStorage.setItem(userid, JSON.stringify(user));
            // Show success message
            const successMsg = document.getElementById('success-message');
            successMsg.textContent = 'Saved successfully!';
            successMsg.style.display = 'block';
            setTimeout(() => successMsg.classList.add('show'), 10);

            // Update page after 1s
            setTimeout(() => {
                location.reload();
            }, 1000);
        });

        // Validate old password on blur
        document.getElementById('old-password').addEventListener('blur', () => {
            checkOldPassword();
        });
        // Validate new password on blur
        document.getElementById('password').addEventListener('blur', () => {
            checkPassword();
        });
        // Validate confirm password on blur
        document.getElementById('confirm-password').addEventListener('blur', () => {
            checkConfirmPassword();
        });
        // Confirm button click event
        document.getElementById('reset-password-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const userid = localStorage.getItem('token');
            let user = JSON.parse(localStorage.getItem(userid));
            const oldPassword = document.getElementById('old-password').value;
            let password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            // Validate all fields
            if(!checkOldPassword() || !checkPassword() || !checkConfirmPassword()) return;
            // Validate new password and confirm password match
            if(password !== confirmPassword) {
                document.getElementById('cp-error-message').textContent = 'Passwords do not match, please re-enter.';
                // Clear password fields
                document.getElementById('old-password').value = '';
                document.getElementById('password').value = '';
                document.getElementById('confirm-password').value = '';
                return;
            }
            // Validate old password
            if(simpleHash(oldPassword, userid) !== user.password) {
                document.getElementById('op-error-message').textContent = 'Old password is incorrect.';
                // Clear password fields
                document.getElementById('old-password').value = '';
                document.getElementById('password').value = '';
                document.getElementById('confirm-password').value = '';
                return;
            }
            // Update password
            password = simpleHash(password, userid);
            user.password = password;
            // Update localstorage
            localStorage.setItem(userid, JSON.stringify(user));
            // Show success message
            const successMsgPass = document.getElementById('success-message-password');
            successMsgPass.textContent = 'Password changed successfully!';
            successMsgPass.style.display = 'block';
            setTimeout(() => successMsgPass.classList.add('show'), 10);
            
            // Redirect to login after 2s
            setTimeout(() => {
                window.location.href = '../account/login.html';
            }, 2000);
        });
        // Validate old password
        function checkOldPassword() {
            const oldPassword = document.getElementById('old-password').value;
            if(!oldPassword) {
                document.getElementById('op-error-message').textContent = 'Old password cannot be empty.';
                return false;
            }
            else {
                document.getElementById('op-error-message').textContent = '';
                return true;
            }
        }
        function checkPassword() {
            const password = document.getElementById('password').value;
            if(!password) {
                document.getElementById('pa-error-message').textContent = 'New password cannot be empty.';
                return false;
            }
            else {
                document.getElementById('pa-error-message').textContent = '';
                return true;
            }
        }
        function checkConfirmPassword() {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            if(!confirmPassword) {
                document.getElementById('cp-error-message').textContent = 'Confirm password cannot be empty.';
                return false;
            }
            else if(password !== confirmPassword) {
                document.getElementById('cp-error-message').textContent = 'The two passwords do not match.';
                return false;
            }
            else {
                document.getElementById('cp-error-message').textContent = '';
                return true;
            }
        }
    </script>
</body>
</html>
